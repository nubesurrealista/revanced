name: Build ReVanced Extended

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  check:
    permissions: write-all
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Check for new patches releases
        id: check_releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_RELEASE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/anddea/revanced-patches/releases/latest" | jq -r '.tag_name')
          
          if [ -f .last_patches_version ]; then
            LAST_BUILT=$(cat .last_patches_version)
            if [ "$LATEST_RELEASE" != "$LAST_BUILT" ]; then
              echo "SHOULD_BUILD=1" >> $GITHUB_OUTPUT
              echo "NEW_VERSION=$LATEST_RELEASE" >> $GITHUB_OUTPUT
            else
              echo "SHOULD_BUILD=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "$LATEST_RELEASE" > .last_patches_version
            echo "SHOULD_BUILD=1" >> $GITHUB_OUTPUT
            echo "NEW_VERSION=$LATEST_RELEASE" >> $GITHUB_OUTPUT
          fi
          
      - name: Clear older runs
        if: steps.check_releases.outputs.SHOULD_BUILD == '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run list -L100 --json databaseId -q '.[].databaseId' | tail -n+2 | xargs -IID gh api "repos/$GITHUB_REPOSITORY/actions/runs/ID" -X DELETE || :
    
    outputs:
      SHOULD_BUILD: ${{ steps.check_releases.outputs.SHOULD_BUILD }}
      NEW_VERSION: ${{ steps.check_releases.outputs.NEW_VERSION }}

  build:
    permissions: write-all
    needs: check
    runs-on: ubuntu-latest
    if: ${{ needs.check.outputs.SHOULD_BUILD == 1 }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Update version file
        run: |
          echo "${{ needs.check.outputs.NEW_VERSION }}" > .last_patches_version
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > keystore.p12
          
      - name: Build APKs
        run: |
          chmod +x build.sh
          ./build.sh config.toml
          
      - name: Sign APKs with custom keystore
        run: |
          for apk in build/*.apk; do
            java -jar bin/apksigner.jar sign \
              --ks keystore.p12 \
              --ks-type pkcs12 \
              --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
              --key-pass pass:"${{ secrets.KEYSTORE_ALIAS_PASSWORD }}" \
              --ks-key-alias "${{ secrets.KEYSTORE_ALIAS }}" \
              --out "${apk}.signed" \
              "$apk"
            mv "${apk}.signed" "$apk"
          done
          
      - name: Get version info
        id: versions
        run: |
          YT_VER=$(ls build/*youtube*.apk 2>/dev/null | head -1 | grep -o 'v[0-9.]*' | sed 's/v//' || echo "unknown")
          YTM_VER=$(ls build/*music*.apk 2>/dev/null | head -1 | grep -o 'v[0-9.]*' | sed 's/v//' || echo "unknown")
          
          echo "YOUTUBE_VERSION=$YT_VER" >> $GITHUB_OUTPUT
          echo "MUSIC_VERSION=$YTM_VER" >> $GITHUB_OUTPUT
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "apks-${{ github.run_id }}"
          name: "ReVanced Extended APKs"
          body: |
            YouTube: ${{ steps.versions.outputs.YOUTUBE_VERSION }}
            YouTube Music: ${{ steps.versions.outputs.MUSIC_VERSION }}
            Patches: ${{ needs.check.outputs.NEW_VERSION }}
            
            Built: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          files: |
            build/*.apk
